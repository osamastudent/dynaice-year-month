@extends('layouts.master')
@section('title', 'Profile')
@section('page-style')
<link rel="stylesheet" href="{{ asset('assets/plugins/jquery-datatable/dataTables.bootstrap4.min.css') }}" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="{{ asset('assets/plugins/light-gallery/css/lightgallery.css') }}">
<link rel="stylesheet" href="{{ asset('assets/plugins/fullcalendar/fullcalendar.min.css') }}">

@stop
@section('content')
<style> 
.message-field{
    width: 100% !important;
    /*margin-top:3.2px; */
    /*display: inline-block;*/
}
.nav-link{
    color:black;
}
 .active{
    color:blue !important;
}

a{
    color:black;
}

@media(max-width:767px){
 
.message-popup-mobile-screen{
    width:90% !important;
}

}
    .card .body {
        margin-top: 0
    }

    .btn-sm {
        width: 233px;

    }

    tr.dash_2 {
        font-size: 14px;
    }

    @media only screen and (min-width: 980px) {
        span.datetime {
            float: right;
        }


        p.break {
            font-weight: bolder;
            margin-top: 20px;
            margin-left: 240px;
        }
    }

    button.btn.btn-sm.btn-primary.mt-2 {
        width: 233px;
        height: 50px;
        font-weight: 600;
        font-size: 15px;
        margin-left: 15px;
        margin-right: 15px;
    }

    .text-muted {
        color: #6c757d !important;
        font-size: 15px;
    }

    @media (min-width: 768px) {
        button.btn.btn-sm.btn-primary.mt-2 {
            margin: auto;
            width: 233px;
        }

        p.break {
            text-align: inherit !important;
        }

        span.datetime {
            margin: 5px;
        }

        table.table.table-bordered {
            width: 613px;
        }
    }

    @media only screen and (min-width: 320px) and (orientation: portrait) {

        button.btn.btn-sm.btn-primary.mt-2 {
            width: auto;
            height: auto;
        }

        div#time_track {
            padding-inline: 25px;
        }

        div#time_track_3 {
            margin-left: 0px;
        }

        p.break {
            font-weight: bolder;
            margin-top: 20px;
            text-align: center;
        }
    }

    #time_track {
        height: 433px;

    }

    div#time_track_2 {
        padding-left: 15px;
        padding-right: 15px;
    }

    .col-lg-8.col-md-12.checker1 {
        margin-top: -20px;
    }

    .card .body {
        padding: 10px;
    }

    .body.cards_height {
        height: 200px;
    }
     /* Canvas container styling */
    #chart-container {
        background-color: black; /* Background black */
        padding: 20px;
        border-radius: 10px; /* Smooth border radius */
    }

    /* Ensure canvas adapts well */
    #myChart {
        background-color: black !important; /* Canvas background black */
        /*border-radius: 10px 10px 0 0; */
    }
</style>
<div class="row clearfix">

 <div class="col-11 mx-auto my-3">
    <div class="row">
        <div class="col-md-6">
            <label class="mb-0">Select Year:</label>
             <select name="yearchart" id="yearchart" class="form-control mt-1 border-right-0 show-tick ms select2">
            
                @for ($i = 2020; $i <= date('Y'); $i++)
                    <option value="{{ $i }}" {{ $i == $currentYearChart ? 'selected' : '' }}>{{ $i }}</option>
                @endfor
            </select>
        </div>

        <div class="col-md-6 mt-3 mt-lg-0 mt-md-0">
            <label class="mb-0">Select Month:</label>
             <select name="monthchart" id="monthchart"  class="form-control mt-1 border-right-0 show-tick ms select2">
                @foreach (range(1, 12) as $m)
                    <option value="{{ $m }}" {{ $m == $currentMonthChart ? 'selected' : '' }}>
                        {{ date('F', mktime(0, 0, 0, $m, 1)) }}
                    </option>
                @endforeach
            </select>
        </div> 
    </div> 
    
</div> 

  


<div class="col-12 mx-auto mb-4 border-bottom">
    <div style="position: relative; width: 100%; height: auto;">
        <canvas id="myChart"></canvas>
    </div>
</div>

    
    
    <div class="col-lg-4 mt-2 col-md-12">
        <div id="card" class="card mcard_3 mt-2">
            <div id="body" class="body">
                <img src="{{ $employee->profile_image ? asset('storage/profile_images/' . Auth::user()->employee->profile_image) : asset('img/no_image.png') }}"
                    class="rounded-circle shadow" alt="profile-image" width="200" height="200">
                <h4 class="m-t-10"></h4>
                <div class="row">
                    <div class="col-12">
                        <h5>{{ $employee->first_name . ' ' . $employee->middle_name . ' ' . $employee->last_name }}</h5>
                        <p class="text-muted"><b>Employee ID:</b> {{ $employee->employee_no }}</p>

                        <p class="text-muted"><b>Shift Timing:</b>
                            {{ \Carbon\Carbon::parse($employee->working_time_start)->format('h:i A') }} to
                            {{ \Carbon\Carbon::parse($employee->working_time_end)->format('h:i A') }}
                        </p>
                        <p class="text-muted" style:"font-size:10px;"><b>Designation:</b>
                            {{ $employee->designation->title ?? '' }}
                        </p>
                        <p class="text-muted"><b>Date of Joining:</b>
                            {{ date('j F, Y', strtotime($employee->joining_date)) }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8 col-md-12 checker1">
        <span class="datetime mt-5"><b>Current Date Time: </b><span style="color:red;" id="ct6"></span></span>
        <div id="card" class="card">
            <div id="body" class="body" id="time_track">
                <div class="row">
                    <div class="col-lg-12 col-md-6 col-sm-6" id="time_track_3">
                        <div class="time_track_4" style="display:flex;" class="mb-5">
                            @if (!$checkinDone)
                            <form action="{{ url('checkin') }}" method="POST">
                                @csrf
                                <button type="submit" class="btn btn-sm btn-primary mt-2">Check In</button>
                            </form>&nbsp;
                            @elseif($checkinDone && !$breakinDone)
                            <form action="{{ url('breakin') }}" method="POST">
                                @csrf
                                <button type="submit" class="btn btn-sm btn-primary mt-2">Break</button>
                            </form>&nbsp;

                            <form id="checkout-form" action="{{ url('checkout') }}" method="POST">
                                @csrf
                                @method('PUT')
                                <input type="hidden" name="is_checkin" value="0"> 
                                <!-- osama checkout -->
                                <button type="button" data-toggle="modal" data-target="#report-modal" id="report-modal-refresh" class="btn btn-sm btn-primary mt-2">Check  Out</button>
                            </form>&nbsp;
                            @elseif($breakinDone && $checkinDone)
                            <form action="{{ url('breakout') }}" method="POST">
                                @csrf
                                @method('PUT')
                                <button type="submit" class="btn btn-sm btn-primary mt-2">Break Off</button>
                            </form>
                            @else
                            <p>checkin done</p>
                            @endif

                            @if ($reportSubmittedToday)
                            <button type="button" data-toggle="modal" data-target="#exampleModal" class="btn btn-sm btn-primary mt-2">View Report</button>
                            @else
                            <!--<button type="button" data-toggle="modal" data-target="#report-modal" class="btn btn-sm btn-primary mt-2">Submit Report</button>-->
                            @endif
                        </div>



                        {{-- <div class="row"> --}}
                        <p class="break">Today Time Breaks</p>
                        <table class="table table-bordered" style="text-align:center">
                            <tr>
                                <th>Break In</th>
                                <th>Break Off</th>
                                <th>Total Hours</th>
                            </tr>
                            @foreach ($todayBreakTime as $row)
                            <tr>
                                <td>{{ $row->breakin }}</td> 
                                <td>{{ $row->breakout }}</td>
                                <td>{{ $row->total_hours }}</td>
                            </tr>
                            @endforeach
                            <tr>
                                <th colspan="2">Total Time</th>
                                <td>{{ $sumBreakTime }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{-- <div class="modal fade" id="report-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header text-center">
                        <h5 class="modal-title text-center" style="font-weight: bold" id="exampleModalLabel">Submit Report
                        </h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div style="height: 450px;overflow: auto;" class="modal-body">
                        <form action="{{ url('report') }}" method="POST">
    @csrf
    <input type="hidden" name="status[]" value="pending">
    <div class="form-group">
        <label>Date</label>
        <input id="date" type="date" name="date[]" class="form-control form-control-sm"
            value="{{ date('Y-m-d') }}">
        @error('date')
        <label class="error">{{ $errors->first('date') }}</label>
        @enderror
    </div>
    <div class="form-group">
        <select name="project_id[]" onchange="departmentId(this)"
            class="form-control show-tick ms select2">
            <option>-- Select Project --</option>
            <!---->
            <!--<option disabled selected>-- Select Client --</option>-->
            @foreach ($projects as $project)
            <option value="{{ $project->id }}"
                data-department-id="{{ $project->department_id }}"
                {{ old('project_id') == $project->id ? 'selected' : null }}>
                {{ $project->title ?? '' }}
            </option>
            @endforeach
        </select>
        <input type="hidden" name="department_id[]" id="department_id" value="">

    </div>
    <div class="form-group">
        <label>Progress</label>
        <textarea name="progress[]" class="form-control form-control-sm">{{ old('progress') }}</textarea>

        @error('progress')
        <label class="error">{{ $errors->first('progress') }}</label>
        @enderror
    </div>

    <div class="d-flex justify-content-end">
        <button type="button" id="add"
            class="mt-3 mb-5 btn btn-sm btn-primary">+Add</button>
    </div>

</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
    <button type="submit" class="btn btn-primary">Save changes</button>
</div>
</div>

</form>

</div>
</div> --}}
<div class="modal fade" id="report-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header border-bottom text-center">
                <h5 class="modal-title text-center" style="font-weight: bold" id="exampleModalLabel">Submit Report</h5>
                <button type="button" class="close" style="font-size:2rem;" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div style="height: 450px; overflow: auto;" class="modal-body">  
                <form id="report-form" action="{{ url('checkout') }}" method="POST">
                    @csrf
                    @method('PUT')
                    <input type="hidden" name="is_checkin" value="0">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" name="reports[0][date]" class="form-control form-control-sm" value="{{ date('Y-m-d') }}">
                        @error('date')
                        <label class="error">{{ $errors->first('date') }}</label>
                        @enderror
                    </div>
                    <div class="form-group">
                        <select name="reports[0][project_id]" onchange="departmentId(this)" class="form-control show-tick ms select2">
                            <option>-- Select Project --</option>
                            @foreach ($projects as $project)
                            <option value="{{ $project->id }}" data-department-id="{{ $project->department_id }}">{{ $project->title ?? '' }}</option>
                            @endforeach
                        </select>
                        <input type="hidden" name="reports[0][department_id]" id="department_id" value="">
                    </div>
                    <div class="form-group">
                        <label>Progress</label>
                        <!--<input type="text" name="reports[0][progress]" class="form-control form-control-sm">-->
                        <textarea name="reports[0][progress]" class="form-control form-control-sm"></textarea>
                        @error('progress')
                        <label class="error">{{ $errors->first('progress') }}</label>
                        @enderror
                    </div>
                    <div class="form-group">
                        <label>Hours</label>
                        <input type="text" name="reports[0][hours]" class="form-control form-control-sm" value="{{$hours_diff}}" readonly> 
{{--                        <input type="text" name="reports[0][hours]" class="form-control form-control-sm" value="" id="hours_diff_value" readonly>  --}}
                        @error('hours')
                        <label class="error">{{ $errors->first('hours') }}</label>
                        @enderror
                    </div>
                    <div class="new-form"></div>
                    <div class="d-flex justify-content-center">
                        <button type="button" id="add" class="btn btn-sm btn-primary">+Add</button>
                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" id="save-report" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">View Report</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="row">
                        @foreach ($dailyReports as $dailyReport)
                        <div class="col-md-6">
                            <h5>Project:</h5>
                            <p>{{ $dailyReport->project->title ?? '' }}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Date:</h5>
                            <p>{{ $dailyReport->date ? date('j F, Y', strtotime($dailyReport->date)) : null }}
                            </p>
                        </div>

                        <div class="col-md-6">
                            <h5>Hours:</h5>
                            <p>{{ $dailyReport->hours }}</p>
                        </div>

                        <div class="col-md-12">
                            <h5>Progress:</h5>
                            <p>{{ $dailyReport->progress }}</p>
                        </div>
                        <div class="col-md-12" style="border-bottom:1px solid black">
                            <h5>Status:</h5>
                            <p>{{ $dailyReport->status }}</p>
                        </div>
                        @endforeach
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
</div>
<div class="card" style="margin-bottom:0;">
    <div class="row" id="time_track_2">
        <div class="col-lg-4 col-md-4 col-sm-6">
            <div class="card w_data_1">
                <div class="body cards_height">
                    <div class="w_icon dark"><i class="fas fa-tasks"></i></div>
                    <h4 class="mt-3"></h4>
                    <span class="text-muted">Tasks</span><br>
                    <span class="mb-0">Ongoing {{ $ongoingTaskCount }}</span><br>
                    <span class="mb-0">Pending {{ $pendingTaskCount }}</span><br>
                    <span class="mb-0">In progress {{ $inprogressTaskCount }}</span><br>
                    <span class="mb-0">Completed {{ $completedTaskCount }}</span>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-4 col-sm-6">
            <div class="card w_data_1">
                <div class="body cards_height">
                    <div class="w_icon green"><i class="fal fa-clock"></i></div>
                    <h4 class="mt-3">{{ $totalAttendanceCurrentMonth }}</h4>
                    <span class="text-muted">Total Monthly Check-ins</span>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-4 col-sm-6">
            <div class="card w_data_1">
                <div class="body cards_height">
                    <div class="w_icon cyan"><i class="fas fa-calendar"></i></div>
                    <h4 class="mt-3">{{ $leaveCount }}/14 days</h4>
                    <span class="text-muted">Leaves</span>
                </div>
            </div>
        </div>





    </div>
</div>



</div>
</div>

<div class="body mb-3" id="body">
    <div class="table-responsive">
        <table class="emp-datatable table table-hover" style="width: 100%;background:white;">
            <thead class="thead-light">
                <tr class="text-center">
                    <th class="text-center" style="border: none;color:#1D262D;background:white">Project Title</th>

                    <th class="text-center" style="border: none;color:#1D262D;background:white">Status</th>
                    <th class="text-center" style="border: none;color:#1D262D;background:white">Start Date</th>
                    <th class="text-center" style="border: none;color:#1D262D;background:white">End Date</th>

                </tr>
            </thead>

            <tbody>
                @foreach ($projectTasks as $project)
                <tr data-toggle="collapse" onclick="toggleColor(this)" data-target="#demo1{{ $project->id }}"
                    class="accordion-toggle">
                    <td>
                        <style>

                        </style>

                        <img id="icon" src="{{ asset('img/right.png') }}" width="20" height="20"
                            alt="">


                        {{ $project->title ?? '' }}
                    </td>

                    <td>
                        @if ($project->status == 'completed')
                        <span class="btn "
                            style="border-radius:7px;background:#38C38D;color:white;">Complete</span>
                        @elseif ($project->status == 'process')
                        <span class="btn "
                            style="border-radius:7px;background:#FBAB10;color:white;">Process</span>
                        @elseif ($project->status == 'pending')
                        <span class="btn"
                            style="border-radius:7px;background:#3889FF;color:white;">Pending</span>
                        @endif
                    </td>


                    <td>{{ $project->start_date ? date('j F, Y', strtotime($project->start_date)) : null }}</td>
                    <td>{{ $project->end_date ? date('j F, Y', strtotime($project->end_date)) : null }}</td>

                </tr>
                <tr>
                    <td colspan="6" class="hiddenRow">
                        <div class="accordion-body collapse" id="demo1{{ $project->id }}">
                            <div class="table-responsive">
                                <table class="emp-datatable table table-hover  mt-5">
                                    <thead class="thead-light">
                                        <tr class="dash_2">
                                            <th>Task Discription</th>
                                            <th>Report</th>
                                            <th>Task No</th>
                                            <th>Priority</th>
                                            <th>Assign Date</th>
                                            <th>Deadline Date</th>
                                            <th>Progress</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
    <tbody>
                                    @foreach ($project->tasks as $ongoingPendingTask)
                                        <tr>
                                            <td>
                                                {{ implode(' ', array_slice(str_word_count(strip_tags($ongoingPendingTask->note), 1), 0, 5)) }}
                                                @if (str_word_count(strip_tags($ongoingPendingTask->note)) > 5)
                                                ...
                                                @endif
                                            </td>
                                            <td> <img style="cursor:pointer;" class="img-fluid open-box"
                                                    data-id="{{ $ongoingPendingTask->id }}"
                                                    id="open-box{{ $ongoingPendingTask->id }}"
                                                    src="{{ asset('img/table/message.png') }}" width="25px"
                                                    height="20px" alt="">
                                                <div class="container" style="">
                                                    <div style="margin-top: -30%;"
                                                        id="box{{ $ongoingPendingTask->id }}"
                                                        class="box shadow-lg message-popup-mobile-screen">
                                                        <div class="container">
                                                            <div class="row border-bottom pt-0">
                                                                <div class="col-sm-6 col-6">
                                                                    <div class="d-flex justify-content-start pt-1">
                                                                        <button
                                                                            class="close-box" style="font-size: 2rem;font-weight: 700; color: #a27b7b;">&times;</button>

                                                                    </div>
                                                                </div>
                                                                <div class="col-sm-6 pt-3 col-6">
                                                                    <div class="d-flex justify-content-end">

                                                                        <img class="icon-img"
                                                                            src="{{ asset('img/sidebar/icon.png') }}"
                                                                            width="30" height="30"
                                                                            alt="">
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="row">
                                                                <style>
                                                                    /* width */
                                                                    ::-webkit-scrollbar {
                                                                        width: 1px;
                                                                    }

                                                                    /* Track */
                                                                    ::-webkit-scrollbar-track {
                                                                        background: #f1f1f1;
                                                                    }

                                                                    /* Handle */
                                                                    ::-webkit-scrollbar-thumb {
                                                                        background: #888;
                                                                    }

                                                                    /* Handle on hover */
                                                                    ::-webkit-scrollbar-thumb:hover {
                                                                        background: #555;
                                                                    }
                                                                </style>
                                                                <div style="overflow: auto; max-height: 12em;"
                                                                    class="col-md-12 mt-4">
                                                                    {!! $ongoingPendingTask->note !!}
                                                                </div>
                                                            </div>

                                                        </div>
                                                        <ul class="nav mb-1 mt-3">
                                                            <li class="nav-item">
                                                                <a class="nav-link active"
                                                                    data-id="{{ $ongoingPendingTask->id }}"
                                                                    onclick="handleUpdateTabClick(this)"
                                                                    data-toggle="tab"
                                                                    href="#update-{{ $ongoingPendingTask->id }}"
                                                                    id="ma-update" role="tab">Update</a>
                                                            </li>

                                                            <li class="nav-item">
                                                                <a class="nav-link  files-text "
                                                                    data-id="{{ $ongoingPendingTask->id }}"
                                                                    onclick="handleFilesTabClick(this)"
                                                                    data-toggle="tab"
                                                                    href="#files-{{ $ongoingPendingTask->id }}"
                                                                    id="ma-files" role="tab">Files </a>
                                                            </li>
                                                            <li class="nav-item">
                                                                <a class="nav-link  online-text "
                                                                    data-id="{{ $ongoingPendingTask->id }}"
                                                                    onclick="handleOnlineTabClick(this)"
                                                                    data-toggle="tab"
                                                                    href="#onlineUsers-{{ $ongoingPendingTask->id }}"
                                                                    id="ma-onlineUsers" role="tab">Online Users </a>
                                                            </li>
                                                            <!--osama-->


                                                        </ul>
                                                        <hr style="margin-top:-4px;">
                                                        <div class="tab-content">
                                                            <div class="tab-pan active"
                                                                id="update-{{ $ongoingPendingTask->id }}">
                                                                <div class="container">
                                                                    <div class="row">

                                                                    </div>
                                                                    <style>
                                                                        #message-card {
                                                                            position: relative;


                                                                            background-color: #D2FEF4;
                                                                            width: 191px;
                                                                            text-align: left;

                                                                            border: 1px solid #97C6E3;
                                                                            border-radius: 10px;
                                                                        }
                                                                    </style>


                                                                </div>
                                                                <section style="">
                                                                    <div class="container"> 
                                                                        <div
                                                                            class="row d-flex justify-content-center">
                                                                            <div
                                                                                class="col-md-12 col-lg-12 col-xl-12">
                                                                                <div class="card mb-0">
                                                                                    <div class="card-body"
                                                                                        id="admin-reports-container{{ $ongoingPendingTask->id }}"
                                                                                        style="height: 25em;overflow: auto;"
                                                                                        data-mdb-perfect-scrollbar="true"
                                                                                        style="position: relative; height: 400px">
                                                                                    </div>
                                                                                    <!--<div class="card-body"-->
                                                                                    <!--    id="admin-reports-container{{ $ongoingPendingTask->id }}"-->
                                                                                    <!--    style="height: 25em;overflow: auto;"-->
                                                                                    <!--    data-mdb-perfect-scrollbar="true"-->
                                                                                    <!--    style="position: relative; height: 400px">-->
                                                                                    <!--</div>-->
                                                                                    <div
                                                                                        class="card-footer text-muted d-flex bg-transparent justify-content-start align-items-center border-0">
                                                                                        <div
                                                                                            class="input-group mb-0">
                                                                                            <form
                                                                                                style="width:100%"
                                                                                                data-id="{{ $ongoingPendingTask->id }}"
                                                                                                id="add-report-form">
                                                                                                <input
                                                                                                    type="hidden"
                                                                                                    name="caht_of"
                                                                                                    value="employee">
                                                                                                <input
                                                                                                    type="hidden"
                                                                                                    name="task_id"
                                                                                                    value="{{ $ongoingPendingTask->id }}"
                                                                                                    class="form-control d-inline w-75"
                                                                                                    style="background-color: #FFFFFF;border:none;"
                                                                                                    id="exampleInput"
                                                                                                    placeholder="Write An Update">
                                                                                                <div class="input-group">
                                                                                                <!--<input-->
                                                                                                <!--    type="text" class="message-field form-control exampleInput_inoput"-->
                                                                                                <!--    name="admin_reply"-->
                                                                                                <!--    placeholder="Type message"-->
                                                                                                <!--    aria-label="Recipient's username"-->
                                                                                                <!--    aria-describedby="button-addon2" />-->
                                                                                            
                                                                                                <!--<button-->
                                                                                                <!--    class="btn  btn-warning float-right rounded-0"-->
                                                                                                <!--    type="submit"-->
                                                                                                <!--    id="button-addon2"-->
                                                                                                <!--    style="">-->
                                                                                                <!--    Send-->
                                                                                                <!--    Message-->
                                                                                                <!--</button>-->
                                                                                                
                                                                                                <textarea 
                                                                                            class="message-field form-control exampleInput_inoput" 
                                                                                            name="admin_reply" 
                                                                                            placeholder="Type message" 
                                                                                            aria-label="Admin reply" 
                                                                                            aria-describedby="button-addon2"
                                                                                            rows="2"></textarea>
 
                                                                                                <button
                                                                                                    class="btn btn-primary bg-primary text-light"
                                                                                                    type="submit"
                                                                                                    id="button-addon2"
                                                                                                    style="border-radius:5px;">
                                                                                                    Send Message
                                                                                                </button>
                                                                                              
                                                                                            
                                                                                                
                                                                                                
                                                                                                </div>
                                                                                            </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>

                                                                            </div>
                                                                        </div>

                                                                    </div>
                                                                </section>

                                                            </div>
                                                            <div style="height: auto;overflow: auto;"
                                                                class="tab-pane "
                                                                id="files-{{ $ongoingPendingTask->id }}">

                                                                <button
                                                                    onclick="event.preventDefault(); addFiles({{ $ongoingPendingTask->id }});"
                                                                    style="border: 1px solid #FE8415; margin-left:16px;"
                                                                    id="add-btn" class="btn">+ Add File </button>

                                                                <form id="delete-form" method="post"
                                                                    enctype="multipart/form-data">
                                                                    @method('post')
                                                                    @csrf

                                                                    <input id="file-input" type="file"
                                                                        multiple name="attachment[]"
                                                                        style="display: none;"
                                                                        onchange="document.getElementById('delete-form').submit();">
                                                                </form>

                                                                <div class="container mt-4">
                                                                    <div class="row">
                                                                        @foreach ($project->task_attachment as $taskAttachment)
                                                                        @if ($taskAttachment->task_id == $ongoingPendingTask->id)
                                                                        <div class="col-lg-4 col-md-6 col-12">
                                                                            <div
                                                                                class="card text-center border  shadow-0 rounded " style="border-color:gray">
                                                                                <div
                                                                                    class="d-flex justify-content-end">
                                                                                    <x-options-buttons>
                                                                                        <x-slot
                                                                                            name="buttons">
                                                                                            <li><a
                                                                                                    href="javascript:void(0);">Open
                                                                                                    File</a>
                                                                                            </li>
                                                                                            <li><a
                                                                                                    href="{{ url('admin-task-download/' . $taskAttachment->id) }}">Download
                                                                                                    File
                                                                                                </a>
                                                                                            </li>


                                                                                            <li>
                                                                                                <a onclick="event.preventDefault();document.getElementById('delete').submit();"
                                                                                                    href="{{ url('task-doc-delete/' . $taskAttachment->id) }}">
                                                                                                    Delete
                                                                                                    File
                                                                                                </a>
                                                                                                <form
                                                                                                    id="delete"
                                                                                                    action="{{ url('task-doc-delete/' . $taskAttachment->id) }}"
                                                                                                    method="post">
                                                                                                    @method('delete')
                                                                                                    @csrf
                                                                                                </form>
                                                                                            </li>

                                                                                        </x-slot>
                                                                                    </x-options-buttons>
                                                                                </div>
                                                                                <style>
                                                                                    .card .card-body {
                                                                                        min-height: 80px;
                                                                                    }
                                                                                </style>

                                                                                <div style="background: white;height: 90px;overflow: auto;"
                                                                                    class="card-footer border-0">
                                                                                    <p class="text-dark">{{ $taskAttachment->attachment }}
                                                                                    </p>
                                                                                </div>
                                                                            </div>

                                                                        </div>
                                                                        @endif
                                                                        @endforeach
                                                                    </div>
                                                                </div>

                                                                <style>
                                                                    #add-btn {
                                                                        background-image: linear-gradient(90deg, rgba(254, 148, 0, 1) 0%, rgba(255, 109, 0, 1) 100%);
                                                                        border-color: transparent;
                                                                        -webkit-background-clip: text;
                                                                        -moz-background-clip: text;
                                                                        -webkit-text-fill-color: transparent;
                                                                        -moz-text-fill-color: transparent;
                                                                    }
                                                                </style>
                                                            </div>
                                                            
                                                            <!--online users modal start here-->
                                                            <div style="height:auto;"
                                                                class="tab-pane"
                                                                id="onlineUsers-{{ $ongoingPendingTask->id }}">
          
           
            @php
            $startOfDay = \Carbon\Carbon::yesterday()->startOfDay(); // Kal ka din, e.g., 
$endOfDay = \Carbon\Carbon::today()->endOfDay();
            $onlineUsersShowAll = \DB::table('time_tracker')
                ->whereNull('checkout') // Filter rows where checkout is NULL
                ->select('employee_id', \DB::raw('MAX(date) as latest_date')) // Get the latest date
                ->groupBy('employee_id') // Group by employee_id to ensure uniqueness
                ->whereBetween('created_at', [$startOfDay, $endOfDay])
                ->orderBy('created_at','desc')->get();
            
            // Pre-fetch employee names to avoid querying inside the loop
            $employeeNames = \DB::table('employees')
                ->whereIn('id', $onlineUsersShowAll->pluck('employee_id'))
                ->get()
                ->keyBy('id'); // Use employee ID as the key for easy access
            @endphp
            
            
            {{-- Loop through each online user --}}
            @foreach ($onlineUsersShowAll as $onlineUsersShow)
                @php
                    $employee = $employeeNames->get($onlineUsersShow->employee_id);
                @endphp

    @if ($employee) 
        <div class="row">
        <div class="col-2">
           <div class="name-initial mt-2 rounded-circle" 
             style="width: 40px; 
             height: 40px; 
             display: flex; 
             justify-content: center; 
             align-items: center;
             background-color: {{ '#' . substr(md5($employee->id), 0, 6) }};
             color: white; 
             font-size: 18px;">
            {{ strtoupper(substr($employee->first_name, 0, 1)) }}
            </div> 
        </div>
        <div class="col-10 pt-3">
            <a href="#chatWithUser-{{ $ongoingPendingTask->id }}" chat_employee_receiver_image_att="{{$employee->profile_image}}" chat-employee-id="{{$employee->id}}"  data-id="{{ $ongoingPendingTask->id }}"
            class="text-dark" onclick="handlechatWithUserTabClick(this)">
            {{ ucfirst($employee->first_name) . ' ' . ucfirst($employee->middle_name) . ' ' . ucfirst($employee->last_name) }}</a>
        </div>
        </div>
            
    @endif
@endforeach

                                                             

                                                              
                                                                </div>
                                                            <!--online users modal end here-->
                                                           
                                                            <!-- chat with users modal start here-->
                                                            <div style="height: auto;overflow: auto;"
                                                                class="tab-pane"
                                                                id="chatWithUser-{{ $ongoingPendingTask->id }}">
          <div id="messages_container" style="height: 25em; overflow: auto; text-align:right; padding-right:12px;">
  
        </div>

                                
                                
                                <!--osama working here-->
                                  <form style="width:100%"  class="mt-3" id="employees_messages_form" method="POST"> 
                                    @csrf
    
    
    <input type="hidden" name="sender_id" value="{{ auth()->user()->employee->id }}"> <!-- Current user -->
    <input type="hidden" name="chat_employee_sender_image" value="{{ auth()->user()->employee->profile_image }}"> <!-- Current user -->
    <input type="hidden" name="receiver_id" value="" id="chat_employee_field_to_id"> <!-- Chat recipient -->
    <input type="hidden" name="chat_employee_receiver_image" value="" id="chat_employee_receiver_image_id"> <!-- Chat recipient -->
    <input type="hidden" name="task_id" value="{{ $ongoingPendingTask->id }}"> <!-- Optional: Task -->
    
    <div class="input-group">
        <textarea
            class="message-field form-control exampleInput_inoput"
            name="message"
            placeholder="Type message"
            aria-label="Message"
            aria-describedby="button-addon2"
            rows="2"
            required></textarea>

        <button
            class="btn btn-primary bg-primary text-light"
            type="submit"
            id="employees_messages_form_button"
            style="border-radius:5px;">
            Send Message
        </button>
    </div>
</form>

                                                                                     

                                                                <div class="container mt-4">
                                                                    <div class="row">
                                                                        @foreach ($project->task_attachment as $taskAttachment)
                                                                        @if ($taskAttachment->task_id == $ongoingPendingTask->id)
                                                                        
                                                                        @endif
                                                                        @endforeach
                                                                    </div>
                                                                </div>
                                                                </div>
                                                            <!-- chat with  users modal end here-->
                                                        </div>
                                                    </div>
                                                </div>


                                                <style>
                                                    #body {
                                                        position: relative;
                                                    }

                                                    .box {
                                                        display: none;
                                                        position: absolute;
                                                        right: 0;
                                                        top: 0;
                                                        bottom: 0;
                                                        width: 50%;
                                                        overflow: auto;
                                                        /* Add this property to enable scrolling within the box */
                                                        height:90vh;
                                                        background-color: #fff;
                                                        z-index: 999;
                                                        padding: 20px;
                                                        animation-name: slide-in;
                                                        animation-duration: 0.5s;
                                                        animation-timing-function: ease-in-out;
                                                    }

                                                    @keyframes slide-in {
                                                        from {
                                                            right: -50%;
                                                        }

                                                        to {
                                                            right: 0;
                                                        }
                                                    }

                                                    .close-box {

                                                        border: none;
                                                        background: none;
                                                        font-size: 24px;
                                                        cursor: pointer;
                                                    }



                                                    @media (max-width: 767px) {
                                                        .box {

                                                            width: 50%;
                                                        }
                                                    }
                                                </style>
                                            </td>
                                            <td>{{ $ongoingPendingTask->task_no }}</td>
                                            <td>{{ $ongoingPendingTask->priority }}</td>
                                            <td>{{ $ongoingPendingTask->assign_date ? \Carbon\Carbon::parse($ongoingPendingTask->assign_date)->format('j F, Y') : null }}
                                            </td>
                                            <td>{{ $ongoingPendingTask->deadline_date ? \Carbon\Carbon::parse($ongoingPendingTask->deadline_date)->format('j F, Y') : null }}
                                            </td>
                                            <td>
                                                <p style="margin-bottom: -10px;">
                                                    <small>{{ $ongoingPendingTask->progress }}%</small>
                                                </p>
                                                <div class="progress"
                                                    style="margin-top:8px;background:#F7C600;border-radius:0;">
                                                    <div class="progress-bar l-green" role="progressbar"
                                                        aria-valuenow="89" aria-valuemin="0"
                                                        aria-valuemax="100"
                                                        style="width: {{ $ongoingPendingTask->progress }}%;border-radius:0;">
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                @if ($ongoingPendingTask->status == 'in progress')
                                                <span
                                                    class="badge badge-warning">{{ $ongoingPendingTask->status }}</span>
                                                @elseif ($ongoingPendingTask->status == 'ongoing')
                                                <span
                                                    class="badge badge-primary">{{ $ongoingPendingTask->status }}</span>
                                                @elseif ($ongoingPendingTask->status == 'pending')
                                                <span
                                                    class="badge badge-danger">{{ $ongoingPendingTask->status }}</span>
                                                {{-- @elseif ($ongoingPendingTask->status == 'completed')
                                                             <span class="badge badge-success">{{$ongoingPendingTask->status}}</span> --}}
                                                @endif
                                            </td>
                                            @endforeach
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </td>

                </tr>
                @endforeach
            </tbody>
        </table>
    </div>
</div>
</div>

<!-- Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Time Breaks</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Break Time In</th>
                            <th>Break Time Out</th>
                            <th>Total Break Time</th>
                        </tr>
                    </thead>
                    <tbody id="break-time">
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="onloadModal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Modal Header</h4>
            </div>
            <div class="modal-body">
                <p>Some text in the modal.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>

</div>

@if (auth::user()->role_id == 4)

<div class="row clearfix">
    <div class="col-lg-12">
        <div class="card">
            <div class="header">
                <h2>Missing Check-Outs</h2>
                <ul class="header-dropdown">
                    <li class="dropdown"> <a href="javascript:void(0);" class="dropdown-toggle"
                            data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <i
                                class="zmdi zmdi-more"></i> </a>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li><a href="{{ url('time-tracker') }}">All Checkin</a></li>
                        </ul>
                    </li>
                    <li class="remove">
                        <a role="button" class="boxs-close"><i class="zmdi zmdi-close"></i></a>
                    </li>
                </ul>
            </div>
            <div class="body">
                <div class="table-responsive">
                    <table id="refresh-data" class="admin-datatable table table-hover" style="width: 100%;">
                        <thead class="thead-light">
                            <tr>
                                <th>Options</th>
                                <th>Employee</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Hours</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th>Options</th>
                                <th>Employee</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Hours</th>
                            </tr>
                        </tfoot>
                        <tbody>
                            @foreach ($missingCheckouts as $missingCheckout)
                            <tr>
                                <td>
                                    {{-- <x-options-buttons>
                                        <x-slot name="buttons">
                                            <li><a href="javascript:void(0);" onclick="viewBreakTimeModule({{$time_tracker->id}})">View</a></li>
                                    <li><a href="javascript:void(0);" onclick="editModule({{$time_tracker->id}})">Edit</a></li>
                                    <li>
                                        <a href="{{url('time-tracker/'.$time_tracker->id)}}" onclick="event.preventDefault();
                                                    document.getElementById('delete').submit();">Delete</a>
                                        <form id="delete" action="{{url('time-tracker/'.$time_tracker->id)}}" method="post">
                                            @method('delete')
                                            @csrf
                                        </form>
                                    </li>
                                    </x-slot>
                                    </x-options-buttons> --}}
                                </td>
                                <td>{{ $missingCheckout->employee->first_name . ' ' . $missingCheckout->employee->middle_name . ' ' . $missingCheckout->employee->last_name }}
                                </td>
                                <td>{{ $missingCheckout->date ? date('l j F, Y', strtotime($missingCheckout->date)) : null }}
                                </td>
                                <td>
                                    <p style="margin:0;"><span class="text-primary">Check-In:</span><br>
                                        {{ $missingCheckout->checkin ? date('j F, Y | g:i a', strtotime($missingCheckout->checkin)) : null }}
                                    </p>
                                    <hr style="margin:0;border-top: 1px dashed #bbb8b8;">
                                    <p style="margin:0;"><span class="text-danger">Check-Out:</span><br>
                                        {{ $missingCheckout->checkout ? date('j F, Y | g:i a', strtotime($missingCheckout->checkout)) : '-- Nil --' }}
                                    </p>
                                </td>
                                <td>
                                    <p style="margin:0;"><span class="text-primary">Total Hours:</span><br>
                                        {{ $missingCheckout->total_hours ?? '-- Nil --' }}
                                    </p>
                                    <hr style="margin:0;border-top: 1px dashed #bbb8b8;">
                                    <p style="margin:0;"><span class="text-danger">Break Hours:</span><br>
                                        {{ $missingCheckout->break_hours ?? '-- Nil --' }}
                                    </p>
                                    <hr style="margin:0;border-top: 1px dashed #bbb8b8;">
                                    <p style="margin:0;"><span class="text-success">Working Hours:</span><br>
                                        {{ $missingCheckout->working_hours ?? '-- Nil --' }}
                                    </p>
                                </td>
                            </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>



            </div>
        </div>
    </div>



</div>

<div class="row clearfix">
    <div class="col-lg-12">
        <div class="card">
            <div class="header">
                <h2>Missing Break-Outs</h2>
                <ul class="header-dropdown">
                    <li class="dropdown"> <a href="javascript:void(0);" class="dropdown-toggle"
                            data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <i
                                class="zmdi zmdi-more"></i> </a>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li><a href="{{ url('time-tracker') }}">Todays All Break</a></li>
                        </ul>
                    </li>
                    <li class="remove">
                        <a role="button" class="boxs-close"><i class="zmdi zmdi-close"></i></a>
                    </li>
                </ul>
            </div>
            <div class="body">
                <div class="table-responsive">
                    <table id="refresh-data" class="admin-datatable table table-hover" style="width: 100%;">
                        <thead class="thead-light">
                            <tr>
                                <th>Options</th>
                                <th>Employee</th>
                                <th>Date</th>
                                <th>Time</th>

                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th>Options</th>
                                <th>Employee</th>
                                <th>Date</th>
                                <th>Time</th>

                            </tr>
                        </tfoot>
                        <tbody>
                            @foreach ($MissingTimeBraker as $MissingTimeBraker)
                            <tr>
                                <td>
                                    {{-- <x-options-buttons>
                                        <x-slot name="buttons">
                                            <li><a href="javascript:void(0);" onclick="viewBreakTimeModule({{$time_tracker->id}})">View</a></li>
                                    <li><a href="javascript:void(0);" onclick="editModule({{$time_tracker->id}})">Edit</a></li>
                                    <li>
                                        <a href="{{url('time-tracker/'.$time_tracker->id)}}" onclick="event.preventDefault();
                                                    document.getElementById('delete').submit();">Delete</a>
                                        <form id="delete" action="{{url('time-tracker/'.$time_tracker->id)}}" method="post">
                                            @method('delete')
                                            @csrf
                                        </form>
                                    </li>
                                    </x-slot>
                                    </x-options-buttons> --}}
                                </td>
                                @if ($check = App\Models\Employee::where('id', $MissingTimeBraker->employee_id)->get())
                                <td>
                                    @foreach ($check as $item)
                                    {{ $item->first_name }} {{ $item->last_name }}
                                    @endforeach
                                </td>
                                @else
                                <td>Deleted User </td>
                                @endif
                                <td>{{ $MissingTimeBraker->date ? date('l j F, Y', strtotime($MissingTimeBraker->date)) : null }}
                                </td>
                                <td>
                                    <p style="margin:0;"><span class="text-primary">Break-In:</span><br>
                                        {{ $MissingTimeBraker->breakin ? date('j F, Y | g:i a', strtotime($MissingTimeBraker->breakin)) : null }}
                                    </p>
                                    <hr style="margin:0;border-top: 1px dashed #bbb8b8;">
                                    <p style="margin:0;"><span class="text-danger">Break-Out:</span><br>
                                        {{ $MissingTimeBraker->breakout ? date('j F, Y | g:i a', strtotime($MissingTimeBraker->breakout)) : '-- Nil --' }}
                                    </p>
                                </td>

                            </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>



            </div>
        </div>
    </div>



</div>

@endif

@stop

@section('page-script')
<script src="{{ asset('assets/plugins/light-gallery/js/lightgallery-all.min.js') }}"></script>
<script src="{{ asset('assets/bundles/fullcalendarscripts.bundle.js') }}"></script>
<script src="{{ asset('assets/js/pages/medias/image-gallery.js') }}"></script>
<script src="{{ asset('assets/js/pages/calendar/calendar.js') }}"></script>

<script src="{{ asset('assets/bundles/datatablescripts.bundle.js') }}"></script>
<script src="{{ asset('assets/plugins/jquery-datatable/buttons/dataTables.buttons.min.js') }}"></script>
<script src="{{ asset('assets/plugins/jquery-datatable/buttons/buttons.bootstrap4.min.js') }}"></script>
<script src="{{ asset('assets/plugins/jquery-datatable/buttons/buttons.colVis.min.js') }}"></script>
<script src="{{ asset('assets/plugins/jquery-datatable/buttons/buttons.flash.min.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<!---->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>
<!---->
<script src="{{ asset('assets/plugins/jquery-datatable/buttons/buttons.html5.min.js') }}"></script>
<script src="{{ asset('assets/plugins/jquery-datatable/buttons/buttons.print.min.js') }}"></script>
<script src="{{ asset('assets/js/pages/tables/jquery-datatable.js') }}"></script>
@stop

@push('after-scripts')
<script>
    // Store the initial main hours value
    var mainHours = parseFloat($("input[name='reports[0][hours]']").val()) || 0;

    $('#add').on('click', function() {
        // Get the date value from the existing form field
        var date = $("input[name='reports[0][date]']").val();

        // Create the new row structure for date, project, progress, and hours
        var newRow = `
  <div class="added-row"> 
            <div class="form-group">
                <input type="hidden" name="reports[][status]" value="pending">
                <input type="hidden" name="reports[][date]" value="${date}">
                <label>Select Project</label>
                <select name="reports[][project_id]" onchange="departmentId(this)" class="form-control show-tick ms select2">
                    <option>-- Select Project --</option>
                    @foreach ($projects as $project)
                        <option value="{{ $project->id }}" data-department-id="{{ $project->department_id }}">{{ $project->title ?? '' }}</option>
                    @endforeach
                </select>
                <input type="hidden" name="reports[][department_id]" id="department_id" value="">
            </div>
            <div class="form-group">
                <label>Progress</label>
                <textarea name="reports[][progress]" class="form-control form-control-sm"></textarea>
            </div>
            <div class="form-group">
                <label>Hours</label>
                <input type="text" name="reports[][hours]" class="form-control form-control-sm new-add-row" oninput="adjustMainHours(this)">
            </div>
        </div>
    `;

        // Append the new row to the `new-form` div
        $('.new-form').append(newRow);
    });

    // Function to adjust the main hours field based on input in new hours fields
    function adjustMainHours(element) {
        var inputHours = parseFloat($(element).val()) || 0; // Get the value entered in the new hours field
        var previousHours = $(element).data('previousHours') || 0; // Get the previous value from data attribute

        // Update mainHours by subtracting the difference between previous and current value
        mainHours = mainHours - (inputHours - previousHours);
        $("input[name='reports[0][hours]']").val(mainHours.toFixed(2)); // Update the main hours field

        // Store the current value as previousHours in data attribute for future calculations
        $(element).data('previousHours', inputHours);
    }


    $('.new-form').on('click', '.delete-row', function() {
        $(this).parent().parent().remove();
    });
</script>

<script>
    function departmentId(select) {
        var department_id = $(select).find('option:selected').data('department-id');

        $(select).siblings('input[name="department_id[]"]').val(department_id);
    }
</script>


<script>
    //      $(document).ready(function()
    //      {
    //         $('#exampleModalScrollable').modal('show');

    //         $('#over18').on('click', function (e) {

    //     $('#exampleModalScrollable').modal('hide')

    // });

    //      })
</script>

<script>
    function showModule(id) {
        $.get('/timebreaker/' + id, function(viewTimeTracker) {
            $('#break-time').empty();
            if (viewTimeTracker.length > 0) {
                $.each(viewTimeTracker, function(index, value) {
                    $('#break-time').append('<tr>' +
                        '<td>' + value.breakin + '</td>' +
                        '<td>' + value.breakout + '</td>' +
                        '<td>' + value.total_hours + '</td>' +
                        '</tr>');
                });

                $('#viewModal').modal('toggle');
            } else {
                $('#break-time').append('<div  style="text-align:center;"><p>Break time not found</p></div>');
                $('#viewModal').modal('toggle');
            };

        });
    }

    $(window).load(function() {
        $('#onloadModal').modal('show');
    })
</script>

<script>
    function display_ct6() {
        var x = new Date()
        var ampm = x.getHours() >= 12 ? ' PM' : ' AM';
        hours = x.getHours() % 12;
        hours = hours ? hours : 12;
        var x1 = x.getMonth() + 1 + "/" + x.getDate() + "/" + x.getFullYear();
        x1 = x1 + " - " + hours + ":" + x.getMinutes() + ":" + x.getSeconds() + ":" + ampm;
        document.getElementById('ct6').innerHTML = x1;
        display_c6();
    }

    function display_c6() {
        var refresh = 1000; // Refresh rate in milli seconds
        mytime = setTimeout('display_ct6()', refresh)
    }
    display_c6();
</script>
<script>
    $(document).on('submit', '#add-report-form', function(event) {
        event.preventDefault();
        var taskId = $(this).data('id');


        var formData = $(this).serialize();
        formData += '&taskId=' + taskId;
        $.ajax({
            url: "{{ url('add-report-admin') }}", // update the route name
            type: "POST",
            data: formData,
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            },
            dataType: "json",
            success: function(response) {
                $('.exampleInput_inoput').val('');

                var container = $('#admin-reports-container' +
                    taskId); // the ID of the container div
                container.empty();

                $.each(response, function(index, report) {
                    var cardClass = (report.report_of == 'employee') ?
                        'justify-content-end' :
                        'justify-content-start';
                    var cardtype = (report.report_of == 'admin') ? 'Admin' : 'You';
                    if (report.report_of == 'employee') {
                        var cardHtml = '<div class="d-flex justify-content-between">';

                        cardHtml += '<p class="small mb-1" style="visibility:hidden">' +
                            report.user_id + '</p>';
                        cardHtml += '<p class="small mb-1 text-muted d-none" style="visibility:hidden">' + report.user_id +
                            '</p>';
                        cardHtml += '</div>';
                    } else {
                        var cardHtml = '<div class="d-flex justify-content-between">';
                        cardHtml += '<p class="small mb-1 text-muted" style="visibility:hidden">' + report.user_id +
                            '</p>';
                        cardHtml += '<p class="small mb-1" style="visibility:hidden">' +
                            report.user_id + '</p>';
 
                        cardHtml += '</div>';
                    }
                    if (report.report_of == 'admin') {
                        $image_path = 'https://hrm.thedatech.com/img/datech-logo.png';
                    } else if (report.report_of == 'client') {
                        $image_path =
                            'https://hrm.thedatech.com/public/storage/client_profile_images/' +
                            report.client_image;
                    } else {
                        $image_path =
                            'https://hrm.thedatech.com/public/storage/profile_images/' +
                            report.employee_image;
                    }

                     cardHtml += `
    <div class="d-flex flex-row osama ${cardClass}" style="align-items: center; gap: 10px;">
        <!-- Profile Image -->
        <img src="${$image_path}" 
             alt="${cardtype} avatar" 
             style="width: 1.5rem; height: 1.5rem; border-radius: 50%; flex-shrink: 0;">

        <!-- Message Text -->
        <div style="max-width: calc(100% - 2.7rem);">
            <p class="small px-2 py-2 mb-0 rounded-3" 
               style="background-color: #d1e7dd; color: black; border-radius: 7px; 
                      word-wrap: break-word; word-break: break-word; 
                       display: inline-block;">
                ${report.admin_reply}
            </p>
        </div>
    </div>`;



                    // append the HTML code to the container div
                    container.append(cardHtml);
                });



            },
            error: function(xhr, status, error) {
                // handle error response
            }
        });
    });
</script>
<script>
    $('.open-box').on('click', function() {
        var id = $(this).attr('data-id');
        console.log(id)
        $('#box' + id).toggle();
        $.ajax({
            url: "{{ url('get-report-admin') }}", // update the route name
            type: "GET",
            data: {
                id: id
            },
            dataType: "json",
            success: function(response) {

                var container = $('#admin-reports-container' + id); // the ID of the container div
                container.empty();


                $.each(response, function(index, report) {
                    var cardClass = (report.report_of == 'employee') ?
                        'justify-content-end' :
                        'justify-content-start';
                    var cardtype = (report.report_of == 'admin') ? 'Admin' : 'You';
                    if (report.report_of == 'employee') {
                        var cardHtml = '<div class="d-flex justify-content-between">';

                        cardHtml += '<p class="small mb-1" style="visibility:hidden">' +
                            report.user_id + '</p>';
                        cardHtml += '<p class="small mb-1 text-muted d-none">' + report.user_id +
                            '</p>';
                        cardHtml += '</div>';
                    } else {
                        var cardHtml = '<div class="d-flex justify-content-between">';
                        cardHtml += '<p class="small mb-1 text-muted d-none">' + report.user_id +
                            '</p>';
                        cardHtml += '<p class="small mb-1" style="visibility:hidden">' +
                            report.user_id + '</p>';

                        cardHtml += '</div>';
                    }
                    if (report.report_of == 'admin') {
                        $image_path = 'https://hrm.thedatech.com/img/datech-logo.png';
                    } else if (report.report_of == 'client') {
                        $image_path =
                            'https://hrm.thedatech.com/public/storage/client_profile_images/' +
                            report.client_image;
                    } else { 
                        $image_path =
                            'https://hrm.thedatech.com/public/storage/profile_images/' +
                            report.employee_image;
                    }

                  cardHtml += `
    <div class="d-flex flex-row osama ${cardClass}" style="align-items: center; gap: 10px;">
        <!-- Profile Image -->
        <img src="${$image_path}" 
             alt="${cardtype} avatar" 
             style="width: 1.5rem; height: 1.5rem; border-radius: 50%; flex-shrink: 0;">

        <!-- Message Text -->
        <div style="max-width: calc(100% - 2.7rem);">
            <p class="small px-2 py-2 mb-0 rounded-3" 
               style="background-color: #d1e7dd; color: black; border-radius: 7px; 
                      word-wrap: break-word; word-break: break-word; 
                       display: inline-block;">
                ${report.admin_reply}
            </p>
        </div>
    </div>`;




                    // append the HTML code to the container div
                    container.append(cardHtml);
                });
            },
            error: function(xhr, status, error) {
                // handle error response
            }
        });

    });
</script>
<script>
    $('.close-box').on('click', function() {
        $(this).closest('.box').hide();
    }); 
</script>
<script>
$("#ma-files").css("color", "black");
    function handleFilesTabClick(element) {
        // alert("files");
        event.preventDefault();
        var id = $(element).data('id');
        $('#update-' + id).hide();
        $('#onlineUsers-' + id).hide();
        $('#chatWithUser-' + id).hide();
        $('#files-' + id).show();
        $("#ma-files").css("color", "blue");
        $("#ma-update").css("color", "black");
        $("#ma-onlineUsers").css("color", "black");
    }

    function handleUpdateTabClick(element) {
        // alert("update");
        event.preventDefault();
        var id = $(element).data('id')
        $('#files-' + id).hide();
        $('#onlineUsers-' + id).hide();
        $('#chatWithUser-' + id).hide();
        $('#update-' + id).show();
        
    $("#ma-files").css("color", "black");
    $("#ma-update").css("color", "blue");
    
    $("#ma-onlineUsers").css("color", "black");
}

$("#ma-onlineUsers").css("color", "black");
    function handleOnlineTabClick(element) {
        // alert("files");
        event.preventDefault();
        var id = $(element).data('id');
        $('#update-' + id).hide();
        $('#files-' + id).hide();
        $('#chatWithUser-' + id).hide();
        $('#onlineUsers-' + id).show();
        
        $("#ma-onlineUsers").css("color", "blue");
        $("#ma-files").css("color", "black");
        $("#ma-update").css("color", "black");

    }

    
     function handlechatWithUserTabClick(element) { 
    var id = $(element).data('id'); // Get the task ID
    var chatEmployeeId = $(element).attr('chat-employee-id'); // Use attr() to get the chat-employee-id
    var chatEmployeeImageId = $(element).attr('chat_employee_receiver_image_att'); // Use attr() to get the chat-employee-id

    // Debugging to ensure the values are correct
    // alert("Task ID: " + id + "\nEmployee ID: " + chatEmployeeId);

    // Set the value of the input field with the employee ID
    $("#chat_employee_field_to_id").val(chatEmployeeId);
    $("#chat_employee_receiver_image_id").val(chatEmployeeImageId);
    

    // Show and hide relevant sections
    $('#update-' + id).hide();
    $('#files-' + id).hide();
    $('#onlineUsers-' + id).hide();
    $('#chatWithUser-' + id).show();
    // Update the navigation colors
    $("#ma-onlineUsers").css("color", "blue");
    $("#ma-files").css("color", "black");
    $("#ma-update").css("color", "black");
    
    let senderId = $("input[name='sender_id']").val();
    let senderImageId = $("input[name='chat_employee_sender_image']").val();
    let receiverId = $("#chat_employee_field_to_id").val();
    let receiverImageId = $("#chat_employee_receiver_image_id").val();
    let taskId = $("input[name='task_id']").val();
    // alert(senderId + " " + receiverId + " " + taskId);
    // Send AJAX POST request
    // osama working here
      $.ajax({
        type: "GET",
        url: "{{ route('employees.messages.get') }}",
        data: {
            sender_id: senderId, 
            sender_image: senderImageId, 
            receiver_id: receiverId, 
            receiver_image: receiverImageId, 
            task_id: taskId,
            
        },

// Assuming 'response' contains the messages
success: function (response) {
    if (response && response.length > 0) { 
        let messagesHtml = "";
        response.forEach(function (message) {
            let isSender = message.sender_id == senderId; // Check if the message is sent by the current user

            messagesHtml += `
                <div class="message-item ${isSender ? 'sender-message' : 'receiver-message'}">
                    <div class="message-content mt-2 mb-2 d-flex ${isSender ? 'justify-content-end' : 'justify-content-start'} align-items-center">
                        
                        <!-- Profile Image -->
                        <div class="message-profile" style="flex-shrink: 0; margin-right: 10px;">
                            <img class="d-none" src="/storage/profile_images/${isSender 
                                ? (message.sender_profile_image || 'default.jpg') 
                                : (message.receiver_profile_image || 'default.jpg')}" 
                                 alt="${isSender ? 'Sender' : 'Receiver'} Profile Image" 
                                 style="height: 1.7rem; width: 1.7rem; border-radius: 50%; border: 2px solid #ccc;">
                        </div>

                        <!-- Message Bubble -->
                        <span style="background-color: ${isSender ? '#d1e7dd' : '#f5f6f7'}; 
                                    color: black; 
                                    padding: 6px 10px; 
                                    border-radius: 7px;
                                    text-align: left;
                                    max-width: 60%; 
                                    word-wrap: break-word; 
                                    display: inline-block;">
                            ${message.message}
                        </span>
                    </div>

                    <!-- Timestamp -->
                    <div style="font-size: 0.8rem; color: gray; text-align: ${isSender ? 'right' : 'left'}; margin-top: 2px;">
                        ${new Date(message.created_at).toLocaleString()}
                    </div>
                </div>`;
        });

        // Insert the messages into the container
        $("#messages_container").html(messagesHtml);
    } else {
        // No messages found
        $("#messages_container").html("<p>No conversations yet.</p>");
    }
},


        error: function (response) {
            if (response.responseJSON && response.responseJSON.message) {
                alert(response.responseJSON.message); // Display error message
            } else {
                alert("dddd unexpected error occurred. Please try again.");
            }
        },
    }); 
    
} 

// employee send message start here
    
 $("#employees_messages_form_button").on("click", function (event) {
    event.preventDefault(); // Prevent form submission

    // Collect input values
    let senderId = $("input[name='sender_id']").val();
    let senderImageId = $("input[name='chat_employee_sender_image']").val();
    let receiverId = $("#chat_employee_field_to_id").val();
    let receiverImageId = $("#chat_employee_receiver_image_id").val();
    let taskId = $("input[name='task_id']").val();
    let msg = $("textarea[name='message']").val();

    // Ensure message field is not empty
    if (!msg.trim()) {
        alert("Please type a message before sending.");
        return;
    }

    // Send AJAX POST request
    $.ajax({
        type: "POST",
        url: "{{ route('employees.messages.store') }}",
        data: {
            sender_id: senderId, 
            sender_image: senderImageId, 
            receiver_id: receiverId,
            receiver_image: receiverImageId,
            task_id: taskId,
            message: msg,
            _token: "{{ csrf_token() }}" // CSRF token for Laravel
        },
        success: function (response) {
            if (response.success) {
                // Clear the message field
                $("textarea[name='message']").val("");

                // Set sender/receiver status
                let isSender = true; // Assuming the current user is the sender

                // Prepare the HTML for the message
                let messageHtml = `
                    <div class="message-item ${isSender ? 'sender-message' : 'receiver-message'}">
                        <div class="message-content mt-2 mb-2 d-flex ${isSender ? 'justify-content-end' : 'justify-content-start'} align-items-center">
                            <!-- Profile Image -->
                            <div class="message-profile" style="flex-shrink: 0; margin-right: 10px;">
                                <img class="d-none" src="/storage/profile_images/${isSender ? senderImageId : receiverImageId}" 
                                     alt="${isSender ? 'Sender' : 'Receiver'} Profile Image" 
                                     style="height: 1.7rem; width: 1.7rem; border-radius: 50%; border: 2px solid #ccc;">
                            </div>

                            <!-- Message Bubble -->
                            <span style="background-color: ${isSender ? '#d1e7dd' : '#f5f6f7'}; 
                                        color: black; 
                                        padding: 6px 10px; 
                                        border-radius: 7px;
                                        text-align: left;
                                        max-width: 60%; 
                                        word-wrap: break-word; 
                                        display: inline-block;">
                                ${msg}
                            </span>
                        </div>

                        <!-- Timestamp -->
                        <div style="font-size: 0.8rem; color: gray; text-align: ${isSender ? 'right' : 'left'}; margin-top: 2px;">
                            ${new Date().toLocaleString()}
                        </div>
                    </div>
                `;

                // Append the new message to the message container
                $("#messages_container").append(messageHtml);

                // Scroll to the bottom of the messages container smoothly
                $("#messages_container").animate({ scrollTop: $("#messages_container")[0].scrollHeight }, "fast");
            }
        },
        error: function (response) {
            if (response.responseJSON && response.responseJSON.message) {
                alert(response.responseJSON.message); // Display error message
            } else {
                alert("An unexpected error occurred. Please try again.");
            }
        },
    });
});

// employee send message end here
// employee show messages end here
function fetchMessages(senderId, receiverId) {
    $.ajax({
        type: "GET",
        url: `/employees-messages/${senderId}/${receiverId}`,
        success: function (messages) {
            let messagesContainer = $("#messages_container");
            // messagesContainer.empty();

            // Append each message with profile image
            messages.forEach(message => {
                let profileImage = message.sender.profile_image || "default-profile.png"; // Replace with actual image URL or default image

                let messageHTML = `
                    <div class="d-flex align-items-start mb-3">
                        <img src="/storage/profiles/${profileImage}" alt="Profile Image" 
                             class="rounded-circle me-3" 
                             style="width: 50px; height: 50px; object-fit: cover;">
                        <div class="message-content">
                            <p class="mb-1 ${message.sender_id == senderId ? 'bg-primary text-white' : 'bg-light text-dark'} p-3 rounded">
                                ${message.message}
                            </p>
                            <small class="text-muted">${new Date(message.created_at).toLocaleString()}</small>
                        </div>
                    </div>
                `;
                messagesContainer.append(messageHTML);
            });
        },
        error: function () {
            alert("Failed to fetch messages.");
        }
    });
}


// employee show messages end here
    
    
    
</script>

<script>
// alert("aaa");
    function updateProgress(select) {
        var id = $(select).data('id');

        var progress = $(select).val();

        $.ajax({
            url: '/update-progress',
            type: 'GET',
            data: {
                'progress': progress,
                'id': id
            },
            success: function(data) {
                console.log("success");

                var container = $('#alert-container');

                var cardHtml =
                    '<div class="alert alert-success alert-dismissible fade show mb-1" role="alert">';
                cardHtml += '<button type="button" class="close" data-dismiss="alert" aria-label="Close">';
                cardHtml += '<span aria-hidden="true">&times;</span>';
                cardHtml += '</button>';
                cardHtml += '<strong>Done!</strong> Progress has been updated.';
                cardHtml += '</div>';

                container.append(cardHtml);;
                setTimeout(function() {
                    container.find('.alert').alert('close');
                }, 3000);

            }

        });
    }

function addFiles(id) {
        // alert("ID: " + id);

        var form = document.getElementById('delete-form');
        if (form) {
            form.action = '{{ url("store-task-attachment") }}/' + id;
            console.log("Form action updated:", form.action);
        } else {
            console.error("Form not found!");
        }

        var fileInput = document.getElementById('file-input');
        if (fileInput) {
            fileInput.click();
        } else {
            console.error("File input not found!");
        }
    }
    // function addFiles(id) {

    //     var form = document.getElementById('delete-form');
    //     form.action = '{{ url('
    //     store - task - attachment ') }}/' + id;
    //     document.getElementById('file-input').click();
    // }
</script>
<script>
    $('.close-box').on('click', function() {
        $(this).closest('.box').hide();
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var checkoutButton = document.getElementById('checkout-btn');
        var reportForm = document.getElementById('report-form');
        var checkoutField = document.getElementById('checkout-field');

        // Handle Check Out button click
        checkoutButton.addEventListener('click', function() {
            // Add a hidden field to indicate that checkout should happen
            checkoutField.value = '1';

            // Also set the form to submit a PUT request
            if (!document.getElementById('_method')) {
                var methodField = document.createElement('input');
                methodField.setAttribute('type', 'hidden');
                methodField.setAttribute('name', '_method');
                methodField.setAttribute('value', 'PUT');
                methodField.setAttribute('id', '_method');
                reportForm.appendChild(methodField);
            }
        });

        // Handle Save changes button click in modal
        document.getElementById('save-report').addEventListener('click', function() {
            // If checkoutField has a value, change the form action to checkout URL
            if (checkoutField.value === '1') {
                reportForm.action = "{{ url('checkout') }}";
            } else {
                // Default action for only submitting the report
                reportForm.action = "{{ url('report') }}";
                // Ensure that the request is a POST request for submitting the report
                var methodField = document.getElementById('_method');
                if (methodField) {
                    methodField.remove();
                }
            }
            reportForm.submit();
        });
    });

    $(document).ready(function() {
        $('#report-form').on('submit', function(event) {
            event.preventDefault();

            // Show a confirmation dialog
            var confirmed = confirm("Are you sure you want to submit the checkout and the report?");
            if (confirmed) {
                // Submit the form if confirmed
                this.submit();
            }
        });

        $('#add').on('click', function() {
            var newForm = `<div class="form-group">
            <label>Date</label>
            <input type="date" name="reports[${$('.new-form .form-group').length}][date]" class="form-control form-control-sm" value="{{ date('Y-m-d') }}">
        </div>
        <div class="form-group">
            <select name="reports[${$('.new-form .form-group').length}][project_id]" onchange="departmentId(this)" class="form-control show-tick ms select2">
                <option>-- Select Project --</option>
                @foreach ($projects as $project)
                    <option value="{{ $project->id }}" data-department-id="{{ $project->department_id }}">{{ $project->title ?? '' }}</option>
                @endforeach 
            </select> 
            <input type="hidden" name="reports[${$('.new-form .form-group').length}][department_id]" id="department_id" value="">
        </div>
        <div class="form-group">
            <label>Progress</label>
            <input type="text" name="reports[${$('.new-form .form-group').length}][progress]" class="form-control form-control-sm">
        </div>
        <div class="form-group">
            <label>Hours</label>
            <input type="text" name="reports[${$('.new-form .form-group').length}][hours]" class="form-control form-control-sm">
        </div>`;
            $('.new-form').append(newForm);
        }); 
    });

    function departmentId(select) {
        var departmentId = $(select).find('option:selected').data('department-id');
        $(select).closest('form').find('input[name$="[department_id]"]').val(departmentId);
    }
</script> 


{{-- // <script>
//     var reportModalRefresh = document.getElementById("report-modal-refresh");
//     reportModalRefresh.addEventListener("click", function () {
//         $.ajax({
//             type: "GET",
//             url: "{{ route('fetchHourseWithMinutes') }}",
//             success: function (response) {
//                 if (response.success) {
//                     document.getElementById("hours_diff_value").value = response.hours_diff;
//                 } else {
//                     alert('Unable to fetch the hours difference.');
//                 }
//             },
//             error: function () {
//                 alert('An error occurred while fetching data.');
//             }
//         });
//     });
// </script> --}}


 <script>
 // Add click event listener to the button
 var reportModalRefresh = document.getElementById("report-modal-refresh");
reportModalRefresh.addEventListener("click", function () {
    // Save state in sessionStorage to remember the modal state
    sessionStorage.setItem('modalState', 'open');
    // Reload the page
    location.reload();
});

// Check if the modal state is stored in sessionStorage
if (sessionStorage.getItem('modalState') === 'open') {
    // Show the modal after the page reloads 
    $(document).ready(function () { 
        $('#report-modal').modal('show');
        // Clear the modal state so it doesn't keep reopening
        sessionStorage.removeItem('modalState');
    }); 
}
 
 </script>
 
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById('myChart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: @json($labels),
                datasets: [{
                    label: 'Working Hours', 
                    data: @json($workingHoursData), 
                    backgroundColor: 'rgb(255, 153, 72)', /* Bars color */
                    borderColor: 'green', /* Line color green */
                    borderWidth: 2,
                    borderRadius: {
                        topLeft: 10, /* Rounded top left */
                        topRight: 10 /* Rounded top right */
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        min: 1,
                        max: 9,
                        ticks: {
                            color: 'white', /* Y-axis text white */
                            stepSize: 1
                        },
                        grid: {
                            color: 'green', /* Grid lines green */
                            borderWidth: 1
                        }
                    },
                    x: {
                        ticks: {
                            color: 'white' /* X-axis text white */
                        },
                        grid: {
                            color: 'green' /* Grid lines green */
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: 'white' /* Legend text color white */
                        }
                    }
                }
            }
        });
    });
</script>


<script>
    var selectedYear, selectedMonth;
var myChart;

document.addEventListener("DOMContentLoaded", function () {
    const ctx = document.getElementById('myChart').getContext('2d');

    // Initialize the chart
    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Working Hours',
                data: [],
                backgroundColor: 'rgb(255, 153, 72)',
                borderColor: 'green',
                borderWidth: 2,
                borderRadius: {
                    topLeft: 10,
                    topRight: 10
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    min: 1,
                    max: 10,
                    ticks: { color: 'white', stepSize: 1 },
                    grid: { color: 'green', borderWidth: 1 }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'green' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: 'white' }
                }
            }
        }
    });

    // Default data load karein
    loadChartData();
});

// Event listeners for dropdowns
document.getElementById("yearchart").addEventListener("change", function() {
    selectedYear = this.value;
    updateChartData();
});
document.getElementById("monthchart").addEventListener("change", function() {
    selectedMonth = this.value;
    updateChartData();
});

// Function to fetch and update chart data
function updateChartData() {
    if (selectedYear && selectedMonth) {
        loadChartData(selectedYear, selectedMonth);
    }
}

// Load chart data with optional year & month
function loadChartData(year = null, month = null) {
    $.ajax({
        url: "{{ route('chart.data') }}",
        type: "GET",
        data: { year: year, month: month },
        success: function(response) {
            if (response.success) {
                // Chart ko update karein
                myChart.data.labels = response.labels;
                myChart.data.datasets[0].data = response.workingHoursData;
                myChart.update();

                // Dropdowns ko bhi default values dein
                if (!year && !month) {
                    document.getElementById("yearchart").value = response.year;
                    document.getElementById("monthchart").value = response.month;
                    selectedYear = response.year;
                    selectedMonth = response.month;
                }
            } else {
                alert('Failed to load data');
            }
        },
        error: function() {
            alert('An error occurred while making the request.');
        }
    });
}

</script>

@endpush


in controller
    public function dashboard()
{
    
    // dd("dddd");
    try { 
        $employee = Auth::user()->employee;

// $now = Carbon::now();
// $startOfDay = Carbon::today()->setHour(7)->setMinute(0)->setSecond(0);

// if ($now->hour >= 7) {
//     $endOfDay = Carbon::tomorrow()->setHour(6)->setMinute(59)->setSecond(59);
// } else {
//     $endOfDay = Carbon::today()->setHour(6)->setMinute(59)->setSecond(59);
// }
$startOfDay = Carbon::yesterday()->startOfDay(); // Kal ka din, e.g., 2025-01-23 00:00:00
$endOfDay = Carbon::today()->endOfDay();

//         // Fetch employees who have not checked out (missing breakouts) today
        // $MissingTimeBraker = TimeBreaker::whereNull('breakout')
        //     ->whereDate('date', Carbon::today())
        //     // ->whereBetween('created_at', [$startOfDay, $endOfDay])
        //     ->groupBy('employee_id')
        //     ->get();
        
        $MissingTimeBraker = TimeBreaker::whereNull('breakout')
    ->whereDate('date', Carbon::today())
    ->select('employee_id', DB::raw('MAX(date) as latest_date'))
    ->groupBy('employee_id')
    ->get();



// Now you can use $hours_diff as the final calculated value

        // Employees who have checked in today
        $employeeLogin = TimeTracker::select('employee_id')
            ->where('is_checkin', 1)
            ->groupBy('employee_id')
            ->get();

        // Fetch employee leave count for the current year
        $leaveCount = DB::table('leaves')
            ->where('employee_id', $employee->id)
            ->where('status', 'approved')
            ->whereYear('created_at', date('Y'))
            ->sum('days');

        // Task counts based on different statuses
        $ongoingTaskCount = DB::table('tasks')
            ->where('employee_id', $employee->id)
            ->where('status', 'ongoing')
            ->count();

        $pendingTaskCount = DB::table('tasks')
            ->where('employee_id', $employee->id)
            ->where('status', 'pending')
            ->count();

        $inprogressTaskCount = DB::table('tasks')
            ->where('employee_id', $employee->id)
            ->where('status', 'in progress')
            ->count();

        $completedTaskCount = DB::table('tasks')
            ->where('employee_id', $employee->id)
            ->where('status', 'completed')
            ->count();

        // Check if the employee submitted a report today
        $reportSubmittedToday = DB::table('reports')
            ->where('employee_id', $employee->id)
            ->whereDate('date', Carbon::today())
            // ->whereBetween('created_at', [$startOfDay, $endOfDay])
            ->exists();

        // Fetch today's reports with project relation
        $dailyReports = Report::with('project')
            ->select('id', 'date', 'progress', 'hours', 'project_id', 'status', 'department_id')
            ->where('employee_id', $employee->id)
            ->whereDate('date', Carbon::now())
            ->orderBy('created_at','desc')
            // ->whereBetween('created_at', [$startOfDay, $endOfDay])
            ->get();

        // Fetch ongoing and pending tasks with project relation
        $ongoingPendingTasks = Task::where('employee_id', $employee->id)
            ->whereNotIn('status', ['completed'])
            ->with('project')
            ->orderBy('created_at', 'desc')
            ->get();

        // Fetch employee's time tracking records
        $employeeTimes = TimeTracker::where('employee_id', $employee->id)
            ->orderBy('id', 'desc')
            ->get();

        // Fetch missing checkouts for the current month
        $missingCheckouts = TimeTracker::whereNull('checkout')
            ->whereMonth('date', Carbon::now()->month)
            ->get();

        // Fetch projects with tasks assigned to the employee
        $projectTasks = Project::whereHas('tasks', function ($query) use ($employee) {
            $query->where('employee_id', $employee->id)
                ->whereNotIn('status', ['completed'])
                ->orderBy('created_at', 'desc');
        })->with('tasks.project')->get();

        // Fetch projects in 'process' or 'completed' status
        $projects = DB::table('projects')
            ->select('id', 'title', 'department_id')
            ->whereIn('status', ['process', 'completed']) 
            ->get();

        // Check if the employee has checked in and not checked out today
        $checkinDone = TimeTracker::whereNull('checkout')
            ->where('employee_id', $employee->id)
            // ->whereDate('date', Carbon::now())
            ->whereBetween('created_at', [$startOfDay, $endOfDay])
            ->orderBy('created_at','desc')
            ->first();
// dd($checkinDone->id);
        // Check if the employee has started a break without checking out
        $breakinDone = TimeBreaker::whereNull('breakout')
            ->where('employee_id', $employee->id)->orderBy('created_at','desc')
            // ->whereDate('date', Carbon::now())
            ->whereBetween('created_at', [$startOfDay, $endOfDay])
            ->first();

        // Calculate the total attendance for the current month
        $totalAttendanceCurrentMonth = TimeTracker::where('employee_id', $employee->id)
            ->whereMonth('date', Carbon::now()->format('m'))
            ->whereYear('date', Carbon::now()->format('Y'))
            ->count();

        // Check if the employee has an open checkout for today
        $timeTrackercheckoutIsNull = TimeTracker::whereNull('checkout')
            ->where('employee_id', $employee->id)->orderBy('created_at','desc')
            ->whereDate('date', Carbon::now())
            // ->whereBetween('created_at', [$startOfDay, $endOfDay])
            ->first();

        // Fetch today's break times
        $todayBreakTime = TimeBreaker::where('employee_id', $employee->id)
            // ->whereBetween('created_at', [$startOfDay, $endOfDay])
            ->whereDate('date', Carbon::today())
            ->get();

        // Calculate total break time for today
        // if ($timeTrackercheckoutIsNull) {
        //     $sumTotalHours = TimeBreaker::where([
        //         'employee_id' => $employee->id,
        //         'date' => Carbon::today()
        //     ])->sum(DB::raw("TIME_TO_SEC(total_hours)"));

        //     $sumBreakTime = gmdate("H:i:s", $sumTotalHours);
        // } else { 
        //     $sumBreakTime = "00:00:00";
        // }
        
 if ($timeTrackercheckoutIsNull) {
    // Calculate total break hours for the employee today
    $sumTotalHours = TimeBreaker::where('employee_id', $employee->id)->orderBy('id')
        // ->whereBetween('created_at', [$startOfDay, $endOfDay])
        ->whereDate('date', Carbon::today())
        ->sum(DB::raw("TIME_TO_SEC(total_hours)"));
        

// Convert total seconds to H:i:s format
$sumBreakTime = gmdate("H:i:s", $sumTotalHours);

} else {
    $sumBreakTime = "00:00:00";
}

// Convert $sumBreakTime to fractional hours
$breakHours = Carbon::parse($sumBreakTime)->hour + (Carbon::parse($sumBreakTime)->minute / 60);

// Fetch the current session time for the employee 
// $current_session_time = TimeTracker::where('employee_id', $employee->id)
//     ->whereDate('created_at', Carbon::today())
//     ->where('is_checkin', 1)
//     ->first();

// Fetch the latest check-in for the employee
$latest_checkin = TimeTracker::where('employee_id', $employee->id)
    ->where('is_checkin', 1)
    ->orderBy('created_at', 'desc')
    ->first();

if ($latest_checkin) {
    $checkin_time = Carbon::parse($latest_checkin->checkin, 'Asia/Karachi');

    // Calculate total break hours since the last check-in
    $sumTotalHours = TimeBreaker::where('employee_id', $employee->id)
        ->where('time_tracker_id', $latest_checkin->id) // Filter by the latest check-in's ID
        ->sum(DB::raw("TIME_TO_SEC(total_hours)"));

    // Convert total seconds to H:i:s format
    $sumBreakTime = gmdate("H:i:s", $sumTotalHours);

    // Convert $sumBreakTime to fractional hours
    $breakHours = Carbon::parse($sumBreakTime)->hour + (Carbon::parse($sumBreakTime)->minute / 60);

    // Get the current time
    $current_time = Carbon::now('Asia/Karachi');

    // Calculate the total duration since the last check-in
    $minutes_diff = $checkin_time->diffInMinutes($current_time);

    // Convert minutes to fractional hours
    $hours_diff = $minutes_diff / 60;

    // Subtract the break hours from the total hours
    $hours_diff -= $breakHours;

    // Format the result to two decimal places
    $hours_diff = number_format($hours_diff, 2);
} else {
    // Handle case when no check-in exists
    $hours_diff = 0.0;
}

// Get the current year and month
$currentYearChart = Carbon::now()->year;
$currentMonthChart = Carbon::now()->month;

// Fetch the data with the required fields
$totalWorkingHoursCharts = TimeTracker::where('employee_id', auth()->user()->employee_id)
    ->whereYear('checkin', $currentYearChart)
    ->whereMonth('checkin', $currentMonthChart) // You can set this dynamically (1 for January)
    ->pluck('working_hours', 'checkin'); // Fetching both checkin and working_hours

// Group by date (removing the time part from checkin)
$groupedByDate = $totalWorkingHoursCharts->groupBy(function($item, $key) {
    return Carbon::parse($key)->format('Y-m-d'); // Format checkin as Date (YYYY-MM-DD)
});

// Prepare the labels (dates) and working hours data
$labels = [];
$workingHoursData = [];

foreach ($groupedByDate as $date => $records) {
    // Format the date to display as "01 Jan"
    $labels[] = Carbon::parse($date)->format('d M'); 

    // Sum the working hours for the current date
    $totalHours = 0;

    foreach ($records as $record) {
        // Assuming the working hours are in "HH:MM:SS" format
        $timeParts = explode(':', $record);

        // Ensure that the timeParts array has the expected count (HH, MM, SS)
        if(count($timeParts) >= 2) {
            $hours = intval($timeParts[0]);
            $minutes = intval($timeParts[1]);
            $seconds = isset($timeParts[2]) ? intval($timeParts[2]) : 0;

            // Convert time to decimal hours and sum
            $totalHours += $hours + ($minutes / 60) + ($seconds / 3600); 
        }
    }

    // Add the total working hours (rounded to 2 decimal places) to the data array
    $workingHoursData[] = round($totalHours, 2);
}

// For debugging - Check the prepared data
// dd($labels, $workingHoursData);
    return view('user_account.dashboard', compact(
        'currentMonthChart',
        'currentYearChart',
            'labels', 
            'workingHoursData',
              'employee',
            'employeeLogin',
            'leaveCount',
            'ongoingTaskCount',
            'pendingTaskCount',
            'inprogressTaskCount',
            'completedTaskCount',
            'ongoingPendingTasks',
            'checkinDone',
            'breakinDone',
            'employeeTimes',
            'totalAttendanceCurrentMonth',
            'todayBreakTime',
            'sumBreakTime',
            'missingCheckouts',
            'MissingTimeBraker',
            'projects',
            'reportSubmittedToday',
            'dailyReports',
            'projectTasks',
            'hours_diff'
        ));

    } catch (\Exception $e) {
        // Log the error for debugging
        \Log::error('Dashboard Error: ' . $e->getMessage());
        return redirect()->back()->withErrors('An error occurred while loading the dashboard.');
    }
}

  public function getChartData(Request $request)
{
    // Agar user filter na kare to current year aur month set karein
    $userSelectedYearChart = $request->year ?? now()->year;
    $userSelectedMonthChart = $request->month ?? now()->month;

    // Data fetch karein
    $totalWorkingHoursCharts = TimeTracker::where('employee_id', auth()->user()->employee_id)
        ->whereYear('checkin', $userSelectedYearChart)
        ->whereMonth('checkin', $userSelectedMonthChart)
        ->pluck('working_hours', 'checkin');

    // Group by date
    $groupedByDate = $totalWorkingHoursCharts->groupBy(function ($item, $key) {
        return Carbon::parse($key)->format('Y-m-d');
    });

    // Labels aur data prepare karein
    $labels = [];
    $workingHoursData = [];

    foreach ($groupedByDate as $date => $records) {
        $labels[] = Carbon::parse($date)->format('d M');
        $totalHours = 0;

        foreach ($records as $record) {
            $timeParts = explode(':', $record);
            if (count($timeParts) >= 2) {
                $hours = intval($timeParts[0]);
                $minutes = intval($timeParts[1]);
                $seconds = isset($timeParts[2]) ? intval($timeParts[2]) : 0;

                $totalHours += $hours + ($minutes / 60) + ($seconds / 3600);
            }
        }

        $workingHoursData[] = round($totalHours, 2);
    }

    return response()->json([
        'success' => true,
        'message' => 'Show Records successfully.',
        'labels' => $labels,
        'workingHoursData' => $workingHoursData,
        'year' => $userSelectedYearChart,
        'month' => $userSelectedMonthChart
    ]); 
}
Route::get('/emp/dashboard', [App\Http\Controllers\UserDashboardController::class, 'dashboard']); 
Route::get('/get-chart-data', [App\Http\Controllers\UserDashboardController::class, 'getChartData'])->name('chart.data');
